<!DOCTYPE html>
<html>
<head>
    <title>Ticket Timing Predictor</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='frontend.css') }}">
</head>
<body>
    <h1>Mariners Ticket Timing Predictor</h1>
    <div id="output"></div>
    <div id="events"></div>

    <script>
        function clearBoxes(except) {
            const outputDiv = document.getElementById("output");
            const eventsDiv = document.getElementById("events");
            if (except === "output") {
                eventsDiv.innerHTML = "";
            } else if (except === "events") {
                outputDiv.innerHTML = "";
                outputDiv.style.display = "none";
            } else {
                outputDiv.innerHTML = "";
                outputDiv.style.display = "none";
                eventsDiv.innerHTML = "";
            }
        }

        async function getEvents() {
            clearBoxes("events");
            const eventsDiv = document.getElementById("events");
            eventsDiv.innerHTML = "Loading events...";
            try {
                const response = await fetch("/api/events");
                let events = await response.json();
                if (events.error) {
                    eventsDiv.innerText = "Error: " + events.error;
                    return;
                }
                if (!Array.isArray(events)) {
                    if (typeof events === "object" && events !== null) {
                        events = [events];
                    } else {
                        eventsDiv.innerText = "No events found.";
                        return;
                    }
                }
                const today = new Date();
                events = events.filter(ev => {
                    if (!ev.start_date) return false;
                    const eventDate = new Date(ev.start_date);
                    return eventDate >= today;
                });
                events.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));
                events = events.slice(0, 24);
                if (events.length === 0) {
                    eventsDiv.innerText = "No upcoming events found.";
                    return;
                }
                eventsDiv.innerHTML = events.map(ev => {
                    let html = `<div class='event-card'>`;
                    html += `<h3>${ev.event_name || "Unnamed Event"}</h3>`;
                    if (ev.image) html += `<img src="${ev.image}" alt="event image"><br>`;
                    if (ev.start_date || ev.start_time) html += `<b>Date:</b> ${ev.start_date || ""}${ev.start_time ? " " + ev.start_time : ""}<br>`;
                    if (ev.venue_name || ev.city || ev.state || ev.country) {
                        let venue = [ev.venue_name, ev.city, ev.state, ev.country].filter(Boolean).join(", ");
                        if (venue) html += `<b>Venue:</b> ${venue}<br>`;
                    }
                    if (ev.ticket_status) html += `<b>Ticket Status:</b> ${ev.ticket_status}<br>`;
                    if (ev.public_sale_start) html += `<b>Sale Start:</b> ${ev.public_sale_start}<br>`;
                    if (ev.public_sale_end) html += `<b>Sale End:</b> ${ev.public_sale_end}<br>`;
                    if (ev.seatmap_url) html += `<b>Seatmap:</b> <a href="${ev.seatmap_url}" target="_blank">View Seatmap</a><br>`;
                    if (ev.accessibility_info) html += `<b>Accessibility:</b> ${ev.accessibility_info}<br>`;
                    if (ev.ticket_limit) html += `<b>Ticket Limit:</b> ${ev.ticket_limit}<br>`;
                    if (ev.timezone) html += `<b>Timezone:</b> ${ev.timezone}<br>`;
                    if (ev.venue_timezone) html += `<b>Venue Timezone:</b> ${ev.venue_timezone}<br>`;
                    if (ev.segment) html += `<b>Segment:</b> ${ev.segment}<br>`;
                    if (ev.genre) html += `<b>Genre:</b> ${ev.genre}<br>`;
                    if (ev.subGenre) html += `<b>SubGenre:</b> ${ev.subGenre}<br>`;
                    if (ev.url) html += `<b>Event URL:</b> <a href="${ev.url}" target="_blank">Link</a><br>`;
                    html += `<button onclick="runModelForEvent('${ev.event_name}', '${ev.start_date}')">Run Model for This Event</button>`;
                    html += `</div>`;
                    return html;
                }).join('');
            } catch (err) {
                eventsDiv.innerText = "Request failed: " + err;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            getEvents();
        });

        async function runModelForEvent(eventName, eventDate) {
            clearBoxes("output");
            const outputDiv = document.getElementById("output");
            outputDiv.style.display = "block";
            outputDiv.innerText = `Running model for ${eventName} (${eventDate})...`;
            try {
                const response = await fetch("/run", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ event_name: eventName, event_date: eventDate })
                });
                const data = await response.json();
                if (data.error) {
                    outputDiv.innerText = "Error: " + data.error;
                    return;
                }

                const today = new Date();
                const eventDateObj = new Date(data.event_date);

                let buyDayOverall = new Date(eventDateObj);
                buyDayOverall.setDate(eventDateObj.getDate() - (data.buy_days_overall || 0));
                let daysUntilBuyOverall = Math.ceil((buyDayOverall - today) / (1000 * 60 * 60 * 24));

                let recommendationColor = '#38a169';
                if (data.recommendation) {
                    const rec = data.recommendation.toLowerCase();
                    if (rec.includes('not purchasing at all') || rec.includes('no, do not buy')) {
                        recommendationColor = '#e53e3e';
                    } else if (rec.includes('buy if you really want') || rec.includes('waiting') || rec.includes('do not recommend buying right now')) {
                        recommendationColor = '#4b6cb7';
                    } else if (rec.includes('optimal time has passed') || rec.includes('optimal time recently passed') || rec.includes('prices may be higher')) {
                        recommendationColor = '#eab308';
                    } else if (rec.includes('buy now') || rec.includes('now is the optimal time to buy')) {
                        recommendationColor = '#38a169';
                    }
                }

                outputDiv.innerHTML = `
                  <div class="results-container">
                    <div class="results-header">
                      <h2>${data.event || eventName}</h2>
                      <div class="date"><b>Date:</b> ${data.event_date || eventDate}</div>
                    </div>

                    <div class="results-grid">
                      <div class="result-card">
                        <h3><span>üéØ</span>Prediction</h3>
                        <div class="result-item"><b>Probability optimal:</b> <span style="color:#4b6cb7; font-weight:600;">${typeof data.optimal_probability === 'number' ? data.optimal_probability.toFixed(2) : (data.optimal_probability !== undefined && data.optimal_probability !== null ? data.optimal_probability : 'N/A')}</span></div>
                        <div class="result-item"><b>Predicted price range:</b> <span style="color:#2a3d66; font-weight:600;">$${data.predicted_price_range && data.predicted_price_range[0] !== undefined ? data.predicted_price_range[0].toFixed(2) : 'N/A'} - $${data.predicted_price_range && data.predicted_price_range[1] !== undefined ? data.predicted_price_range[1].toFixed(2) : 'N/A'}</span></div>
                        <div class="result-item"><b>Buy if price ‚â§</b> <span style="color:#4b6cb7; font-weight:600;">$${data.buy_price_range && data.buy_price_range[1] !== undefined ? data.buy_price_range[1].toFixed(2) : 'N/A'}</span></div>
                      </div>
                      <div class="result-card">
                        <h3><span>‚è±Ô∏è</span>Timing Analysis</h3>
                        <div class="result-item"><b>Overall Optimal Buy Days:</b> <span style="color:#4b6cb7; font-weight:600;">${data.buy_days_overall || 'N/A'} days before event</span></div>
                        <div class="result-item"><b>Recommendation:</b> <span style="color:${recommendationColor}; font-weight:600;">${data.recommendation || 'N/A'}</span></div>
                      </div>
                    </div>
                    
                    <div class="result-table">
                      <table>
                        <thead>
                          <tr>
                            <th>Section</th>
                            <th style="text-align:center;">Predicted Price</th>
                            <th style="text-align:center;">Buy If Price ‚â§</th>
                            <th style="text-align:center;">Absolute Optimal Time to Buy</th>
                            <th style="text-align:center;">Upcoming Optimal Time to Buy</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${Object.keys(data.predicted_price_by_section || {}).map(section => {
                            const predPrice = data.predicted_price_by_section[section];
                            const buyRange = data.buy_price_by_section && data.buy_price_by_section[section];
                            const buyDays = data.buy_days_by_section && data.buy_days_by_section[section];
                            let buyDaySection = new Date(data.event_date || eventDate);
                            buyDaySection.setDate(buyDaySection.getDate() - (buyDays || 0));
                            let daysUntilBuySection = Math.ceil((buyDaySection - new Date()) / (1000 * 60 * 60 * 24));
                            return `<tr>
                              <td style="font-weight:600;">${section}</td>
                              <td style="text-align:center; color:#2a3d66; font-weight:600;">$${predPrice !== null && predPrice !== undefined ? predPrice.toFixed(2) : 'N/A'}</td>
                              <td style="text-align:center; color:#4b6cb7; font-weight:600;">$${buyRange && buyRange[1] ? buyRange[1].toFixed(2) : 'N/A'}</td>
                              <td style="text-align:center;">${buyDays !== undefined ? buyDays + ' days in advance' : 'N/A'}</td>
                              <td style="text-align:center; color:#2a3d66; font-weight:600;">${Math.max(0, daysUntilBuySection) === 0 ? 'today' : Math.max(0, daysUntilBuySection) + ' days from now'}</td>
                            </tr>`;
                          }).join('')}
                        </tbody>
                      </table>
                    </div>

                    <div class="back-button-container">
                      <button class="back-button" onclick="backToHome()">Back to Home</button>
                    </div>
                  </div>
                `;
            } catch (err) {
                outputDiv.innerText = "Request failed: " + err;
            }
        }

        function backToHome() {
            clearBoxes("events");
            getEvents();
        }
    </script>
</body>
</html>